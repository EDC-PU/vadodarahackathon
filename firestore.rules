
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAppAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Problem statements can be read by any authenticated user.
    // Only admins can create, update, or delete them.
    match /problemStatements/{statementId} {
      allow read: if request.auth != null;
      allow write: if isAppAdmin();
    }

    // Teams can be read by authenticated users.
    // Only team leaders or admins can update team details.
    match /teams/{teamId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.leader.uid || isAppAdmin();
      allow delete: if isAppAdmin();
    }

    // Users can read and update their own profile.
    // Admins can read and update ANY user's profile.
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAppAdmin();
      allow create: if request.auth != null;
      allow update: if request.auth.uid == userId || isAppAdmin();
    }

    // SPOCs can be created by admins.
    match /spocs/{spocId} {
        allow read: if isAppAdmin() || request.auth.uid == spocId;
        allow write: if isAppAdmin();
    }
  }
}
